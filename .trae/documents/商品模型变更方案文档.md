# 商品模型变更方案文档

## 1. 变更概述

为了优化系统数据结构并提高代码一致性，需要进行以下两项变更：
1. **删除商品中的stock字段**，并确保所有涉及stock的增删改查操作都能正常兼容
2. **将Product类型中的category字段改为category_id**，确保所有涉及category字段的增删改查操作都能正常兼容

## 2. 变更分析

### 2.1 stock字段现状分析

- 在`src/db/index.ts`中的Product接口定义包含stock字段
- 在`BulkProductCreate.tsx`中有设置默认库存值的代码
- 在`ProductsPage.tsx`中，商品表单和表格显示都不包含stock字段
- 系统当前业务流程中似乎并未实际使用stock字段进行库存管理

### 2.2 category字段现状分析

- 在Product接口中定义为可选字段：`category?: string;`
- 在`ProductsPage.tsx`中用于商品的分类显示和编辑
- 在`BulkProductCreate.tsx`中用于批量导入商品的分类验证
- 在订单相关逻辑中也有涉及category字段
- 当前存储的是分类ID，但字段名为category，与实际存储内容不匹配

## 3. 变更实施步骤

### 3.1 删除stock字段的实施步骤

1. **修改数据模型定义**
   - 在`src/db/index.ts`中，从Product接口定义中删除stock字段

2. **修改批量创建商品功能**
   - 在`src/components/BulkProductCreate.tsx`中，删除添加商品时设置默认stock值的代码：`stock: 0, // 默认库存为0`

3. **添加数据迁移逻辑**
   - 为确保已有数据的兼容性，在应用启动时添加数据迁移逻辑，清除现有商品数据中的stock字段

### 3.2 将category字段改为category_id的实施步骤

1. **修改数据模型定义**
   - 在`src/db/index.ts`中，将Product接口中的`category?: string;`修改为`category_id?: string;`

2. **修改商品操作服务**
   - 在productService的add和update方法中，修改参数验证和处理逻辑，从category改为category_id

3. **修改商品管理页面**
   - 在`ProductsPage.tsx`中，更新表单和表格渲染逻辑，从使用category字段改为category_id

4. **修改批量创建商品功能**
   - 在`BulkProductCreate.tsx`中，更新导入逻辑中的字段映射，从category映射到category_id

5. **添加数据迁移逻辑**
   - 为确保已有数据的兼容性，在应用启动时添加数据迁移逻辑，将现有商品数据中的category字段值迁移到新的category_id字段

## 4. 兼容性保障策略

### 4.1 向后兼容性保障

1. **数据迁移**
   - 在应用启动时执行一次性数据迁移，将现有商品数据中的category字段值复制到新的category_id字段
   - 对于包含stock字段的历史数据，通过数据访问层过滤掉该字段，确保读取操作的兼容性

2. **访问层适配**
   - 在productService中添加适配层，对于读取操作，同时支持返回category和category_id字段
   - 对于写入操作，同时接受category和category_id参数，并将category参数值赋给category_id字段

3. **版本控制**
   - 在数据存储中添加版本标记，确保迁移操作只执行一次

### 4.2 代码兼容性保障

1. **统一修改**
   - 全面扫描代码库，统一修改所有使用到category和stock字段的地方

2. **类型安全**
   - 利用TypeScript的类型检查功能，确保所有类型定义和使用保持一致

3. **测试覆盖**
   - 确保所有修改都经过充分测试，包括单元测试和集成测试

## 5. 实施计划

1. **准备阶段**（1天）
   - 完成变更方案文档编写
   - 准备数据迁移脚本

2. **实施阶段**（2天）
   - 执行代码修改
   - 添加数据迁移逻辑

3. **测试阶段**（1天）
   - 进行全面测试，确保所有功能正常运行
   - 验证数据迁移的正确性

4. **部署阶段**（1天）
   - 部署变更到生产环境
   - 监控系统运行状况

## 6. 风险评估

| 风险项 | 风险描述 | 应对措施 |
|--------|----------|----------|
| 数据不一致 | 迁移过程中可能出现数据不一致 | 在迁移前备份数据，确保迁移过程的事务性 |
| 代码兼容性 | 未完全修改所有使用相关字段的代码 | 加强代码审查和测试，确保所有使用点都被覆盖 |
| 性能影响 | 数据迁移可能对系统性能造成影响 | 在低峰期执行迁移，使用分批处理减少资源占用 |

## 7. 变更验证标准

1. 系统所有功能正常运行，无报错
2. 现有商品数据正确迁移，无丢失
3. 商品管理、批量导入、订单管理等功能正常工作
4. TypeScript编译无类型错误
5. 测试用例全部通过

通过以上变更方案，可以在不影响系统正常运行的情况下，完成商品模型的优化，提高代码的一致性和可维护性。